---
description: 基于需求文档创建详细的技术设计文档
scripts:
  sh: .specify/scripts/bash/generate-design.sh --json
  ps: .specify/scripts/powershell/generate-design.ps1 -Json
---

在用户批准需求之后，基于功能需求开发一份全面的设计文档，在设计过程中进行必要的研究。

执行步骤：

1. 运行 `{SCRIPT}` 获取当前模块路径和需求文档信息
2. 确保 spec.md 存在并已被用户批准
3. **读取并遵循项目宪法**: 读取 `.specify/memory/constitution.md` 了解项目架构原则和技术约束
4. 检查是否存在类似功能模块，如有则询问用户确认
5. 基于功能需求识别需要研究的技术领域
5. 进行必要的技术调研并建立上下文：
   - 研究相关技术选型
   - 分析架构模式和设计模式
   - 参考最佳实践和解决方案
   - 评估技术风险和复杂度

6. 在 `specs/modules/{feature_name}/design.md` 创建详细设计文档，包含以下部分：

**概述**
- 设计目标和技术目标
- 关键技术决策及理由
- 依赖关系分析

**架构设计**
- 整体架构图（使用Mermaid）
- 关键设计模式应用
- 组件分层和职责划分

**组件和接口**
- 核心组件设计
- API接口设计
- 数据模型定义
- 接口类型定义（TypeScript）

**数据模型**
- 核心实体定义
- 数据关系图
- 数据流设计

**错误处理**
- 错误分类和处理策略
- 异常处理流程
- 用户提示机制

**测试策略和验收测试设计**
- 基于spec.md中的验收标准设计对应的测试实现方案
- 将Gherkin格式的验收场景转换为具体的测试设计
- 说明如何验证每个REQ-XXX需求的验收标准
- 设计单元测试、集成测试和端到端测试的架构
- 为Gherkin场景设计自动化测试的技术实现方案
- 考虑技术栈的测试最佳实践

**性能考虑**
- 性能目标和优化策略
- 缓存策略和异步处理

**安全考虑**
- 安全措施和检查点
- 权限控制策略

**Constitution合规检查 (必须包含)**
*此部分为强制性质量门禁，必须在设计完成前验证*

- **简洁性验证**: 设计是否遵循YAGNI原则，避免过度设计
- **模块化检查**: 组件边界是否清晰，避免紧耦合
- **TDD兼容性**: 设计是否支持测试优先开发
- **增量开发**: 实现计划是否可以分阶段交付
- **技术债务评估**: 设计决策的长期维护成本

**合规性声明**: 
- [ ] 已读取项目宪法并理解所有约束
- [ ] 设计方案符合核心原则要求  
- [ ] 技术选择有明确理由和权衡分析
- [ ] 违反宪法的设计已有充分justification

7. 确保设计解决在需求澄清过程中识别的所有功能需求
8. 突出重要的设计决策及其理由
9. 在设计过程中可以就特定技术决策向用户征求意见
10. 完成设计文档后询问用户："设计看起来好吗？如果是，我们可以继续实现计划。"
11. 如用户要求修改，继续反馈-修订循环直到获得明确批准
12. 如在设计期间发现需求缺口，提供返回需求澄清的选项
13. 收到批准后，明确告知设计阶段完成，并提供下一步指导：

**✅ 技术设计阶段完成！**

**下一步建议：**
- 执行 `/todo` 命令创建可操作的实现任务清单
- 任务规划阶段将把设计转换为具体的编码任务

使用绝对路径进行所有文件操作，确保路径准确性。